# PoC ZigBee сниффера
## Принцип работы
- Данный проект - аппаратный сниффер Zigbee пакетов в сети. Реализован под esp32c6. После включения в UART пишет в формате .pcap, сначала единажды отправляет заголовок файла, а затем и все отловленные пакеты, также модифицированные в .pcap
- Если с момента включения начать писать эти данные в файл, то затем (задав ему расширение .pcap), можно открыть в Wireshark и посмотреть активность в сети в неком offline-формате
- Также можно подключиться к этому же UART, когда нужно, сразу и смотреть активность в сети через Wireshark в прямом эфире (для этого нужно добавить ему дополнительный интерфейс внешнего захвата)

## Инструкция пользования
- Для начала необходимо прошить esp32c6 прошивкой [/ZigbeeSniffer/](/ZigbeeSniffer/). Там, в [sniffer.h](ZigbeeSniffer/main/sniffer.h), можно настроить нужный Zigbee-канал, скорость и пины для UART
- В папке же [/WiresharkSerialAdapter/](./WiresharkSerialAdapter/) лежит исходный код и собранная программа интерфейса внешнего захвата. В файле [tasks.json](WiresharkSerialAdapter/ZigbeeSnifferAdapter/.vscode/tasks.json) можно выбрать параметры сборки (компилятор, пусть, где будет собран исполняемый файл, его название и т.д.)
- Собранный файл [WireSharkSerialAdapter.exe](WiresharkSerialAdapter/WireSharkSerialAdapter.exe) необходимо поместить в папку /Wirechark/extcap/. Теперь, при запуске Wireshark, в нём будет появляться ещё один доступный сетевой интерфейы "ZigbeeSniffer", в его параметрах можно настроить параметры UART, нужный zigbee-канал и начать захват
- Также, чтобы пакеты в которых передаются сообщения ПИРС, помечались отдельно, нужно в папку /Wireshark/plugins/4.4/epan/ поместить собранный диссектор [pirs.dll](WiresharkPIRSDissector/pirs.dll). Теперь такие покеты будут помечаться, как "PIRS"
- В папке [/WiresharkPIRSDissector/pirs/](./WiresharkPIRSDissector/pirs/) лежат исходники диссектора, как его собрать описано ниже.

## Исходный проект интерфеса
- Интерфейс внешнего захвата для Wireshark, реализованного под modbus: [WireSharkSerialAdapter](https://github.com/jzhvymetal/WiresharkSerialAdapter?ysclid=meb3icz7iw12782561)

## Инструкция по сборки диссектора
- Нужно установить оболочку [msys2](https://github.com/msys2/msys2-installer/releases/download/2025-06-22/msys2-x86_64-20250622.exe) и добавить её в PATCH
- Выгрузить исходники [Wireshark](https://github.com/wireshark/wireshark) (обязательно тойже версии (разные ветки репозитория), под которую нужно собрать плагин)
- Далее, в выгруженный проект, по пути /plugins/epan/ помещаем проект диссектора [/WiresharkPIRSDissector/pirs/](./WiresharkPIRSDissector/pirs/)
- Теперь, в корневой папке проета в файле CMakeLists.txt нужно найти место, где указываются пути до плагинов (PLUGIN_SRC_DIRS), это можно сделать найдя имя одного из  диссекторов "gryphon", тут нужно указать путь и до нашего плагина "plugins/epan/pirs"
- После этого запускаем терминал "MSYS2 MSYS", переходим в проекте Wireshark в папку tools, там запускаем через этот терминал "msys2-setup.sh", если процесс загрузки компонентов будет прерываться, нужно повторять запуск этого скрипта из того же терминала до тех пор, пока не получим сообщения, что загружать бошьше нечего
- Теперь, создадим папку build в директории проекта и перейдём в неё через терминал "MSYS2 MINGW64", где пропишим команды <cmake -G "Ninja" ..>, а затем <ninja -j6> (где цифра рядом с -j - это количество ядер вашего процессора (а можно и без этого параметра))
- Посли того, как Wireshark соберётся (минут через 10), он будет лежать в /build/run/, а в /build/run/plugins/4.4/epan (4.4 - версия, может быть другой) будет лежать пересобранный плагин "pirs.dll"

## Ньюанс по работе диссектора
На данный момент плагин конфликтует на каком-то этапе с расшифровкой пакетов в Wireshark. Он начинает функционировать только после того, как отловится и расшифруется сессионный ключ. Для этого, к примеру, после запуска сниффинга, можно перезапустить одно из устройств в сети или включить новое устройство